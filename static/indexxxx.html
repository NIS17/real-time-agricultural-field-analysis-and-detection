<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agri-AI Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 m-4 max-w-2xl w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">ðŸŒ¾ Agri-AI Suite</h1>

        <div class="mb-6">
            <label class="font-semibold text-gray-700 block text-center">Choose a Tool:</label>
            <div class="mt-2 flex justify-center space-x-4 border-b pb-4">
                <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="model_choice" value="disease" onclick="toggleUI()" checked><span>Plant Disease</span></label>
                <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="model_choice" value="soil" onclick="toggleUI()"><span>Soil Type</span></label>
                <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="model_choice" value="moisture" onclick="toggleUI()"><span>Soil Moisture</span></label>
            </div>
        </div>

        <div id="static_interface">
            <div id="image_interface" class="mt-4">
                <input type="file" id="fileInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <img id="preview" style="max-width: 300px; max-height: 300px; margin: 20px auto; display: none;" class="rounded-lg shadow-md">
            </div>
            <div id="moisture_interface" style="display: none;" class="mt-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <input type="number" id="month" placeholder="Month (1-12)" class="p-2 border rounded"><input type="number" id="day" placeholder="Day (1-31)" class="p-2 border rounded"><input type="number" id="avg_temp" placeholder="Avg Temp (Â°C)" step="any" class="p-2 border rounded"><input type="number" id="avg_wind" placeholder="Avg Wind (m/s)" step="any" class="p-2 border rounded"><input type="number" id="avg_ws" placeholder="Avg Wind Speed (km/h)" step="any" class="p-2 border rounded"><input type="number" id="avg_sol_rad" placeholder="Avg Solar Rad" step="any" class="p-2 border rounded"><input type="number" id="s_1_t" placeholder="Sensor 1 Temp" step="any" class="p-2 border rounded"><input type="number" id="s_2_t" placeholder="Sensor 2 Temp" step="any" class="p-2 border rounded"><input type="number" id="s_3_t" placeholder="Sensor 3 Temp" step="any" class="p-2 border rounded"><input type="number" id="s_4_t" placeholder="Sensor 4 Temp" step="any" class="p-2 border rounded">
                </div>
            </div>
            <button onclick="getPrediction()" class="w-full mt-6 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Get Prediction</button>
        </div>

        <div id="realtime_interface" class="mt-4 text-center" style="display:none;">
            <p class="text-sm text-gray-500 mb-2">Live camera feed:</p>
            <video id="webcam" width="400" height="300" autoplay playsinline style="display:none;"></video>
            <canvas id="canvas" width="400" height="300" class="border rounded-lg shadow-md bg-black mx-auto"></canvas>
            <div class="mt-4 flex justify-center space-x-4">
                <button id="startButton" onclick="startWebcam()" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-green-700">Start Webcam</button>
                <button id="stopButton" onclick="stopWebcam()" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-red-700" disabled>Stop Webcam</button>
            </div>
        </div>

        <div id="output" class="mt-6 text-center min-h-[50px] p-4 bg-gray-50 rounded-lg">Waiting for input...</div>
    </div>

<script>
    const imageInterface = document.getElementById('image_interface');
    const moistureInterface = document.getElementById('moisture_interface');
    const staticInterface = document.getElementById('static_interface');
    const realtimeInterface = document.getElementById('realtime_interface');
    const outputDiv = document.getElementById('output');
    const previewImg = document.getElementById('preview');
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    let websocket, stream, intervalId;

    function toggleUI() {
        const selectedModel = document.querySelector('input[name="model_choice"]:checked').value;
        stopWebcam();
        if (selectedModel === 'moisture') {
            staticInterface.style.display = 'block';
            realtimeInterface.style.display = 'none';
            moistureInterface.style.display = 'block';
            imageInterface.style.display = 'none';
        } else {
            staticInterface.style.display = 'block';
            realtimeInterface.style.display = 'block';
            moistureInterface.style.display = 'none';
            imageInterface.style.display = 'block';
        }
        outputDiv.innerText = 'Waiting for input...';
        previewImg.style.display = 'none';
    }

    async function getPrediction() {
        const selectedModel = document.querySelector('input[name="model_choice"]:checked').value;
        outputDiv.innerText = 'Processing...';
        let endpoint = '', options = {};
        if (selectedModel === 'moisture') {
            endpoint = '/predict/moisture';
            const inputData = {
                Month: parseInt(document.getElementById('month').value, 10), Day: parseInt(document.getElementById('day').value, 10),
                avg_temp: parseFloat(document.getElementById('avg_temp').value), avg_wind: parseFloat(document.getElementById('avg_wind').value),
                avg_ws: parseFloat(document.getElementById('avg_ws').value), avg_sol_rad: parseFloat(document.getElementById('avg_sol_rad').value),
                s_1_t: parseFloat(document.getElementById('s_1_t').value), s_2_t: parseFloat(document.getElementById('s_2_t').value),
                s_3_t: parseFloat(document.getElementById('s_3_t').value), s_4_t: parseFloat(document.getElementById('s_4_t').value),
            };
            if (Object.values(inputData).some(v => isNaN(v))) { outputDiv.innerText = 'Please fill all fields.'; return; }
            options = { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(inputData) };
        } else {
            const file = document.getElementById('fileInput').files[0];
            if (!file) { outputDiv.innerText = 'Please select an image file.'; return; }
            previewImg.src = URL.createObjectURL(file);
            previewImg.style.display = 'block';
            const formData = new FormData();
            formData.append('file', file);
            endpoint = selectedModel === 'disease' ? '/predict/disease' : '/predict/soil';
            options = { method: 'POST', body: formData };
        }
        try {
            const response = await fetch(endpoint, options);
            if (!response.ok) throw new Error(`Server error: ${response.status}`);
            const data = await response.json();
            if (data.predicted_moisture !== undefined) {
                outputDiv.innerHTML = `<h2 class="text-xl font-semibold">Predicted Moisture: <span class="text-blue-600">${data.predicted_moisture.toFixed(3)}</span></h2>`;
            } else {
                let predictionText = data.prediction.replace(/_/g, ' ');
                outputDiv.innerHTML = `<h2 class="text-xl font-semibold">Prediction: <span class="text-green-600">${predictionText}</span></h2><p class="text-gray-600">Confidence: ${(data.confidence * 100).toFixed(2)}%</p>`;
            }
        } catch (error) { outputDiv.innerText = `Error: ${error.message}`; }
    }

    async function startWebcam() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.play();
            startButton.disabled = true; stopButton.disabled = false;
            outputDiv.innerText = "Connecting to server...";
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            websocket = new WebSocket(`${protocol}//${window.location.host}/ws/realtime`);
            websocket.onopen = () => { outputDiv.innerText = "Connection successful. Point camera at a target."; intervalId = setInterval(sendFrame, 150); };
            websocket.onmessage = (event) => { const img = new Image(); img.src = event.data; img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height); };
            websocket.onerror = () => { outputDiv.innerText = "Connection error."; stopWebcam(); };
        } catch (err) { outputDiv.innerText = "Could not access webcam."; }
    }

    function sendFrame() {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = video.videoWidth; tempCanvas.height = video.videoHeight;
            tempCanvas.getContext('2d').drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
            const imageData = tempCanvas.toDataURL('image/jpeg', 0.8);
            websocket.send(JSON.stringify({ model_type: document.querySelector('input[name="model_choice"]:checked').value, image_str: imageData }));
        }
    }

    function stopWebcam() {
        if (stream) stream.getTracks().forEach(track => track.stop());
        if (websocket) websocket.close();
        if (intervalId) clearInterval(intervalId);
        startButton.disabled = false; stopButton.disabled = true;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    toggleUI(); // Set initial UI state
</script>
</body>
</html>